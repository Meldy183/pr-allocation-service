openapi: 3.0.3
info:
  title: User Gateway Service
  description: |
    Фасад-сервис для пользователей. 
    Оркестрирует pr-allocation-service и code-storage-service.
    Валидирует права доступа пользователей к репозиториям своей команды.
  version: "1.0.0"

tags:
  - name: Profile
    description: Информация о пользователе
  - name: Teams
    description: Управление командами
  - name: Repository
    description: Работа с репозиториями и коммитами
  - name: PullRequests
    description: Управление Pull Requests
  - name: Health

components:
  parameters:
    UsernameHeader:
      name: X-Username
      in: header
      required: true
      schema:
        type: string
      description: Имя текущего пользователя (строка)

    PRNameQuery:
      name: pr_name
      in: query
      required: true
      schema:
        type: string
      description: Имя Pull Request

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - ACCESS_DENIED
                - USER_NOT_FOUND
                - USER_INACTIVE
                - TEAM_NOT_FOUND
                - COMMIT_NOT_FOUND
                - PR_NOT_FOUND
                - PR_ALREADY_EXISTS
                - PR_ALREADY_MERGED
                - NOT_REVIEWER
                - INVALID_REQUEST
                - INTERNAL_ERROR
            message:
              type: string
      example:
        error:
          code: ACCESS_DENIED
          message: "You don't have access to this repository"

    UserProfile:
      type: object
      required: [username, team_name, is_active]
      properties:
        user_id:
          type: string
          description: ID пользователя (в ответе)
        username:
          type: string
        team_id:
          type: string
          format: uuid
          description: UUID команды (в ответе)
        team_name:
          type: string
        is_active:
          type: boolean

    Commit:
      type: object
      required: [created_at]
      properties:
        commit_id:
          type: string
          format: uuid
          description: UUID коммита (в ответе)
        root_commit:
          type: string
          format: uuid
          description: UUID корневого коммита (в ответе)
        parent_commit_ids:
          type: array
          items:
            type: string
            format: uuid
          description: UUID родительских коммитов (в ответе)
        commit_name:
          type: string
          description: Человекочитаемое имя коммита
        repo_name:
          type: string
          description: Имя репозитория (имя root commit)
        created_at:
          type: string
          format: date-time

    PullRequest:
      type: object
      required: [title, author_name, status, created_at]
      properties:
        pr_id:
          type: string
          description: ID пулл реквеста (в ответе)
        pr_name:
          type: string
          description: Уникальное имя PR для запросов
        title:
          type: string
        author_id:
          type: string
          description: ID автора (в ответе)
        author_name:
          type: string
          description: Имя автора
        status:
          type: string
          enum: [OPEN, MERGED, REJECTED]
        reviewer_ids:
          type: array
          items:
            type: string
          description: ID ревьюверов (в ответе)
        reviewer_names:
          type: array
          items:
            type: string
          description: Имена ревьюверов
        source_commit_id:
          type: string
          format: uuid
          description: UUID source коммита (в ответе)
        source_commit_name:
          type: string
          description: Имя source коммита
        target_commit_id:
          type: string
          format: uuid
          description: UUID target коммита (в ответе)
        target_commit_name:
          type: string
          description: Имя target коммита
        root_commit_id:
          type: string
          format: uuid
          description: UUID репозитория (в ответе)
        repo_name:
          type: string
          description: Имя репозитория
        team_name:
          type: string
          description: Имя команды
        created_at:
          type: string
          format: date-time
        merged_at:
          type: string
          format: date-time
          nullable: true

    PullRequestList:
      type: object
      required: [pull_requests]
      properties:
        pull_requests:
          type: array
          items:
            $ref: '#/components/schemas/PullRequest'

    TeamMember:
      type: object
      required: [username, is_active]
      properties:
        user_id:
          type: string
          description: ID пользователя (в ответе)
        username:
          type: string
        is_active:
          type: boolean

    Team:
      type: object
      required: [team_name, members]
      properties:
        team_id:
          type: string
          format: uuid
          description: UUID команды (в ответе)
        team_name:
          type: string
        members:
          type: array
          items:
            $ref: '#/components/schemas/TeamMember'

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/me:
    get:
      tags: [Profile]
      summary: Получить профиль текущего пользователя
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
      responses:
        '200':
          description: Профиль пользователя
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/UserProfile'
        '404':
          description: Пользователь не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/team/create:
    post:
      tags: [Teams]
      summary: Создать команду с участниками
      description: |
        Создаёт команду с указанными участниками.
        Пользователь работает с именами (team_name, username), 
        под капотом всё мапается на UUID.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [team_name, members]
              properties:
                team_name:
                  type: string
                  description: Уникальное имя команды
                members:
                  type: array
                  items:
                    type: object
                    required: [username]
                    properties:
                      username:
                        type: string
                        description: Уникальное имя пользователя
                      is_active:
                        type: boolean
                        default: true
            example:
              team_name: backend
              members:
                - username: alice
                  is_active: true
                - username: bob
                  is_active: true
      responses:
        '201':
          description: Команда создана
          content:
            application/json:
              schema:
                type: object
                properties:
                  team:
                    $ref: '#/components/schemas/Team'
        '400':
          description: Команда уже существует
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/team/get:
    get:
      tags: [Teams]
      summary: Получить команду по имени
      description: Возвращает информацию о команде включая UUID и участников.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: team_name
          in: query
          required: true
          schema:
            type: string
          description: Имя команды
      responses:
        '200':
          description: Информация о команде
          content:
            application/json:
              schema:
                type: object
                properties:
                  team:
                    $ref: '#/components/schemas/Team'
        '404':
          description: Команда не найдена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/repo/init:
    post:
      tags: [Repository]
      summary: Инициализировать новый репозиторий для команды
      description: Создаёт root commit с начальным кодом. Пользователь должен быть активным.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [team_name, repo_name, commit_name, code]
              properties:
                team_name:
                  type: string
                  description: Имя команды
                repo_name:
                  type: string
                  description: Уникальное имя репозитория
                commit_name:
                  type: string
                  description: Имя начального коммита (например "main" или "initial")
                code:
                  type: string
                  format: binary
                  description: ZIP архив с исходным кодом (≤ 100MB)
      responses:
        '201':
          description: Репозиторий инициализирован
          content:
            application/json:
              schema:
                type: object
                required: [commit]
                properties:
                  commit:
                    $ref: '#/components/schemas/Commit'
        '403':
          description: Пользователь неактивен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Пользователь или команда не найдены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/repo/push:
    post:
      tags: [Repository]
      summary: Создать новый коммит
      description: Создаёт коммит поверх существующего. Проверяет доступ к репозиторию команды.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [team_name, repo_name, parent_commit_name, commit_name, code]
              properties:
                team_name:
                  type: string
                  description: Имя команды
                repo_name:
                  type: string
                  description: Имя репозитория (имя root commit)
                parent_commit_name:
                  type: string
                  description: Имя родительского коммита
                commit_name:
                  type: string
                  description: Имя нового коммита
                code:
                  type: string
                  format: binary
                  description: ZIP архив с кодом (≤ 100MB)
      responses:
        '201':
          description: Коммит создан
          content:
            application/json:
              schema:
                type: object
                required: [commit]
                properties:
                  commit:
                    $ref: '#/components/schemas/Commit'
        '403':
          description: Нет доступа к репозиторию
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Репозиторий или родительский коммит не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/repo/checkout:
    get:
      tags: [Repository]
      summary: Получить код коммита
      description: Возвращает ZIP архив с кодом. Проверяет доступ к репозиторию команды.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: team_name
          in: query
          required: true
          schema:
            type: string
          description: Имя команды
        - name: repo_name
          in: query
          required: true
          schema:
            type: string
          description: Имя репозитория
        - name: commit_name
          in: query
          required: true
          schema:
            type: string
          description: Имя коммита
      responses:
        '200':
          description: ZIP архив с кодом
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '403':
          description: Нет доступа к репозиторию
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Коммит не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pr/create:
    post:
      tags: [PullRequests]
      summary: Создать Pull Request
      description: |
        Создаёт PR и автоматически назначает ревьюверов из команды.
        Проверяет, что пользователь имеет доступ к репозиторию.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, pr_name, team_name, repo_name, source_commit_name, target_commit_name]
              properties:
                title:
                  type: string
                  description: Название PR
                pr_name:
                  type: string
                  description: Уникальное имя PR
                team_name:
                  type: string
                  description: Имя команды
                repo_name:
                  type: string
                  description: Имя репозитория
                source_commit_name:
                  type: string
                  description: Имя коммита с изменениями (откуда мержим)
                target_commit_name:
                  type: string
                  description: Имя целевого коммита (куда мержим)
            example:
              title: "Add user authentication"
              pr_name: "auth-feature"
              team_name: "backend"
              repo_name: "main-service"
              source_commit_name: "feature-branch"
              target_commit_name: "main"
      responses:
        '201':
          description: PR создан
          content:
            application/json:
              schema:
                type: object
                required: [pull_request]
                properties:
                  pull_request:
                    $ref: '#/components/schemas/PullRequest'
        '403':
          description: Нет доступа к репозиторию
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: PR уже существует
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pr/my:
    get:
      tags: [PullRequests]
      summary: Получить мои Pull Requests
      description: Возвращает список PR, где текущий пользователь является автором.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [OPEN, MERGED, REJECTED]
          description: Фильтр по статусу
      responses:
        '200':
          description: Список PR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PullRequestList'

  /api/pr/reviews:
    get:
      tags: [PullRequests]
      summary: Получить PR на ревью
      description: Возвращает список PR, где текущий пользователь назначен ревьювером.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [OPEN, MERGED, REJECTED]
          description: Фильтр по статусу
      responses:
        '200':
          description: Список PR на ревью
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PullRequestList'

  /api/pr/approve:
    post:
      tags: [PullRequests]
      summary: Одобрить PR
      description: |
        Одобряет PR и автоматически выполняет merge коммитов в code-storage.
        Только назначенный ревьювер может одобрить PR.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: team_name
          in: query
          required: true
          schema:
            type: string
          description: Имя команды
        - name: pr_name
          in: query
          required: true
          schema:
            type: string
          description: Имя Pull Request
      responses:
        '200':
          description: PR одобрен и смержен
          content:
            application/json:
              schema:
                type: object
                required: [pull_request, merge_commit]
                properties:
                  pull_request:
                    $ref: '#/components/schemas/PullRequest'
                  merge_commit:
                    $ref: '#/components/schemas/Commit'
        '403':
          description: Пользователь не является ревьювером этого PR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: PR не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: PR уже смержен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pr/reject:
    post:
      tags: [PullRequests]
      summary: Отклонить PR
      description: Отклоняет PR. Только назначенный ревьювер может отклонить PR.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: team_name
          in: query
          required: true
          schema:
            type: string
          description: Имя команды
        - name: pr_name
          in: query
          required: true
          schema:
            type: string
          description: Имя Pull Request
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Причина отклонения
      responses:
        '200':
          description: PR отклонён
          content:
            application/json:
              schema:
                type: object
                required: [pull_request]
                properties:
                  pull_request:
                    $ref: '#/components/schemas/PullRequest'
        '403':
          description: Пользователь не является ревьювером этого PR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: PR не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pr/code:
    get:
      tags: [PullRequests]
      summary: Получить код PR
      description: Возвращает ZIP архив с кодом source commit PR. Для ревью.
      parameters:
        - $ref: '#/components/parameters/UsernameHeader'
        - name: team_name
          in: query
          required: true
          schema:
            type: string
          description: Имя команды
        - name: pr_name
          in: query
          required: true
          schema:
            type: string
          description: Имя Pull Request
      responses:
        '200':
          description: ZIP архив с кодом
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '403':
          description: Нет доступа к PR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: PR не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

